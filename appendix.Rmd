---
title: "Appendix"
author: "Max Aantjes"
date: "22/08/2020"
output:
  github_document:
    toc: true
    toc_depth: 3
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# R Packages
The following R packages are used in this analysis.

```{r, message = FALSE}
library(tidyverse)
library(knitr)
library(stringr)
library(ggplot2)
```
# Data Extraction
## Data Source and Relevance
The indicator values for this analysis are taken from the results of the  Ecuadorian National Multi-Purpose Household Survey of December 2019 (Encuesta Nacional Multipropósito de Hogares - Diciembre 2019). The survey collected data for a variety of socio-economic indicators and was conducted by the Ecuadorian national census and statistics institute, INEC. At the time of writing, the form and raw data are available in this [online repository](https://www.ecuadorencifras.gob.ec/encuesta-nacional-multiproposito-de-hogares/). 

## Download
The following code is used to extract the data from the INEC's official website. 

```{r echo = TRUE, results = 'hide', message = FALSE}
url <- "https://www.ecuadorencifras.gob.ec/documentos/web-inec/Multiproposito/2019/BDD_DATOS_ABIERTOS_MULTI%20_2019_12_CSV.zip"
download.file(url, "temp.zip")
unzip("temp.zip")
dfhousehold <- read.csv("BDD_DATOS_ABIERTOS_MULTI _2019_12_CSV//201912_multibdd_equipamiento.sav.csv", sep = ";")
dfperson <-  read.csv("BDD_DATOS_ABIERTOS_MULTI _2019_12_CSV//201912_multibdd_personas.sav.csv", sep = ";")
unlink("BDD_DATOS_ABIERTOS_MULTI _2019_12_CSV", recursive = TRUE)
file.remove("temp.zip")
```

# Data Cleaning
## Missing Values
Missing values will not be removed at this stage for the ```dfperson``` and ```dfequipment``` data sets. The reason for this is that the questions in their respective survey sections were constructed in a hierarchical manner, where answers to earlier questions can make later questions redundant. Follow-up questions (such as for example: do you own a smartphone?) were not asked if the respondent answered "no"to a preceding question (such as for example: do you own a phone?). For this reason, missing values do **not** necessarily indicate missing information. Accordingly, missing values are interpreted, adapted and potentially removed at sub-indicator level, on a case by case basis. The code and rational for this process are available in the other appendix sections.  

## Merging the Two Data Sets
The information on household level and person level is first merged using the *id_hogar* variable. 

```{r}
df <- dfperson %>%
        left_join(dfhousehold, by = "id_hogar") %>%
        rename("area" = 1, "postcode" = 2)
```

## Subset of Data of Interest
Only households with children or young people of schoolgoing age (5 - 18 year-olds) will be considered in this analysis. For this purpose, the data is subsetted. The ```agecheck()``` function checks if there is at least one household member who is between 5 and 18 years old, returning value 1, or not, returning value 0. 

```{r}
agecheck <- function(x){
        y <- 0
        for(i in 1:length(x)){
                if(x[i] %in% 5:18){
                        y <-1}}
        return(y)}
```

The households identification numbers of household where the ```agecheck()``` function returns 1 are then stored in the ```subset``` data frame.  
```{r}
subset <- df %>%
        group_by(id_hogar) %>%
        summarise(subset = agecheck(s1p3)) %>%
        select(id_hogar, subset)
```

The households of interest are subsetted from the ```dfequipment``` data frame. 

```{r}
df <- df %>%
        left_join(subset, by = "id_hogar") %>%
        filter(subset == 1) %>%
        select(-subset)
```

# Analysis
## Availability of Electronic Devices
This sub-indicator estimates relative risk based on the average number of electronic devices per household member. This indicator can be estimated through 8 different variables:

```{r echo = FALSE, results = 'asis'}
names <- c("Code", "Form Section", "Question", "Responses")
code <- c("s1p3", "s7p1a", "s7p1b", "s7p1a1", "s11p11a", "s11p11b", "s11p12a", "s11p12b", "id_hogar", " area")
form.section <- c("Section 1, question 3", "section 7, question 1, subsection 1", "section 7, question 1, subsection 2", "section 7, question 1A", "Section 11, Question 1, subsection 1, subsection 'code'", "Section 11, Question 1, subsection 1, subsection 'number'", "Section 11, question 1, subsection 2, subsection 'code'", "section 11, question 1, subsection 2, subsection 'number'", "-", "-")
question <- c("How old are you? ¿Cuántos años cumplidos tiene (…)?", "Do you have an activated phone? (¿(…) tiene teléfono celular activado?)", "How many activated phones do you have? (¿Cuántos?)", "Is your phone a smartphone? (¿El (los) teléfono (s) celular (es) que tiene (…..) es/son smartphone (teléfono Inteligente, se puede comunicar a través de Wi-Fi, e-mails, red de datos, etc.)?)", "Does the household have a desktop computer? (¿Tiene este hogar: computadora de escritorio?)", "How many desktop computers does the household have? (¿Cuántos tiene?)", "Does the household have a laptop or tablet? (¿Tiene este hogar: computadora laptop/ tablet?)", "How many laptops and tablets does the household have? (¿Cuántos tiene?)", "Identification code for household assigned by INEC", "Determined by Interviewer")
responses <- c("numeric", "1 = yes, 2 = no", "numeric", "1 = yes, 2 = no", "1 = yes, 2 = no", "numeric", "1 = yes, 2 = no", "numeric", "string of characters (numbers)", "1 = rural, 2 = urban")
table <- data.frame(cbind(code, form.section, question, responses))
names(table) <- names
kable(table, caption = "Table 2.1: Relevant Variables for Indicator 2.1")
```

1-4 year olds are removed from the data set as they do not need to use electronic devices nor are expected to use electronic devices.

```{r}
df1 <- df %>%
        filter(s1p3 > 4)
```

The code first assigns the value 0 to variable *s7p1b* (the number of phones the respondent has) if *s7p1a* equals 2 (which means the respondent does not own any activated phone). In other cases the value of *s7p1b* is not changed. There were no NA values in variable *s7p1a* nor in *s7p1b*.

```{r}
df1$s7p1b[df1$s7p1a == 2] <- 0
lapply(list(is.na(df1$s7p1b),is.na(df1$s7p1a)), sum)
```

Next, the code replaces the following values of variable *s7p1a1*: value 2 (which means the respondent's phone(s) is/are **not** smartphone(s)) is replaced with 0; value 1 (which means the respondent's phone(s) is/are smartphone(s)) remains 1. For rows where *s7p1b* equals 0 (which means the respondent does not own any activated phones), the value of *s7p1a1* is also set to 0 (which means the respondent does not own any smartphones). There are no NA values.

```{r}
df1$s7p1a1 <- ifelse(df1$s7p1a1 == 1, 1, 0)
df1$s7p1a1[df1$s7p1b == 0] <- 0
sum(is.na(df1$s7p1a1))
```
Following these operations, the number of smartphones per individual can now be calculated by multiplying *s7p1b* (which indicates the number of activated phones) with *s7p1a1* (which indicates if the respondent has/ does not have a smartphone). Finally, the number of smartphones is summed per household using the *id_hogar* variable. The results are stored in the ```dfphone``` data set.  

```{r}
dfphone <- df1 %>%
        mutate(phone = s7p1b * s7p1a1) %>%
        group_by(id_hogar) %>%
        summarise(no.smartphones = sum(phone))
```
The following code creates a dataframe listing the number of computers, laptops and tablets per household. It first sets the value of variable *s11p11b* (the number of desktop computers) to 0 if *s11p11a* equals 2 (which means the household does not have a desktop computer). There were no NA values in variable *s11p11a* nor in *s11p11b*.
```{r}
df1$s11p11b[df1$s11p11a == 2] <- 0
lapply(list(is.na(df1$s11p11ab),is.na(df1$s11p11b)), sum)
```
Next, the code sets the value of variable *s11p12b* (the number of tablets and laptops) to 0 if *sp11p12a* equals 2 (which means the household does not have a tablet nor laptop). There were no NA values in variable *s11p12a* nor in *s11p12b*.

```{r}
df1$s11p12b[df1$s11p12a == 2] <- 0
lapply(list(is.na(df1$s11p12ab),is.na(df1$s11p12b)), sum)
```

Finally, variables *s11p11b* (the number of desktop computers) and variable *s11p12b* (the number of laptops and tablets) are summed into the *no.computers* variable. The duplicate values for each household (which exist because we have calculated the household value for each household member) are then removed. The results are stored in the ```dfcomputer``` data set. 

```{r}
dfcomputer <- df1 %>%
        mutate(no.computers = s11p11b + s11p12b) %>%
        select(id_hogar, no.computers) %>%
        distinct()
```

The following code creates a data set with the number of members of age 5 and older (respondents under this age have been removed from the data set above).
```{r}
dfmember <- df1 %>%
        count(id_hogar)
```

The following code creates a data set, ```dfarea``` which indicates the area per household.

```{r}
dfarea <- df1 %>%
        select(id_hogar, area) %>%
        mutate(area = factor(area, levels = 1:2, labels = c("urban", "rural"))) %>%
        distinct()
```

The following code calculates for each household how many electronic devices are available for its 5+ year-old members. It then summarises this data across all households for each parroquia. For this purpose, the dfcomputer and dfphone data sets are first merged through the *id_hogar* variable. The variables *computer* (which indicates the number of desktop computers, laptops and tablets in the household) and the variable *phone* (which indicates the number of smartphones in the household) are subsequently summed into the variable *no.devices*. 

Next, the code merges the resulting data set with the dfmember data set through the *id_hogar* variable. The number of devices per household member are then calculated by dividing the *no.devices* (which indicates the total number of electronic devices) with  *n* (which indicates the number of household members). The results are stored in the *ratio* variable. The area is then matched with households by merging the data set with the ```dfarea``` data set. 

```{r}
dfdevices <- dfcomputer %>%
        left_join(dfphone, by = "id_hogar") %>%
        mutate(no.devices = no.computers + no.smartphones) %>%
        left_join(dfmember, by = "id_hogar") %>%
        mutate(ratio = no.devices/n) %>%
        left_join(dfarea, by = "id_hogar")
```

Finally, a graph is created which compares the distribution of device availability across urban and rural regions. 

```{r}
p <- ggplot() + theme_bw()
p1 <- p + geom_boxplot(data = dfdevices, aes(y = ratio, x = area, fill = area)) + ylim(0,3)
p2 <- p1 + geom_hline(aes(yintercept = 1, col = "Ideal\nNumber of\nDevices"), size = 1.2, lty = "dashed") 
p3 <- p2 + labs(y = "Number of Smart Devices per Household\nMember of 5+ years old", x = "", title = "Figure 1: Availability of Smart Devices per Household Member", subtitle = "Based on data from 5,849 households with children and young people of\nschool-going age (5-18 years old).", caption = "Source: INEC Multi-Purpose Household Survey 2019", fill = "")
p4 <- p3 + scale_color_manual(name = "", values = c("Ideal\nNumber of\nDevices" = "#E96519")) + scale_fill_manual(name = "", values = c("urban" = "#907D73", "rural" = "#C1C37F"))
p4
```


## Access To Internet
The access to internet can be estimated with the following variables:

```{r echo = FALSE}
names <- c("Variable", "Form Section", "Question", "Responses")
variable <- c("area", "s11p2")
form.section <- c("-", "Section 11, question 2")
question <- c("Determined by Interviewer", "Does the household have access to internet? (Tiene este hogar acceso a internet?)")
responses <- c("1 = rural, 2 = urban", "1 = yes, 2 = no")
table <- data.frame(cbind(variable, form.section, question, responses))
names(table) <- names
kable(table)
```

The variables are first converted into factor variables. There are no NA values in the data frame.

```{r}
df1 <- df %>%
        mutate(s11p2 = factor(s11p2, levels = 1:2, labels = c("Have Access", "Do not have Access"))) %>%
        mutate(eth = factor(s1p9, levels = 1:8, labels = c("indigenous", "Afroecuadorian", "Black", "Mulato", "montuvio", "mestizo", "white", "other")))
sum(is.na(df$s11p2))
```

The data from respondents aged 5 to 18 is then filtered.

```{r}
df2 <- df1 %>%
        filter(s1p3 %in% 5:18)
nrow(df2)
```

Subsequently, the proportions of respondents with and without access to the internet are calculated for each ethnic group. This is saved in a new data frame. Each ehtnic group is then assigned a rank in accordance with the proportion of respondents having access to internet. 

```{r}
dfacc <- df2 %>%
        group_by(eth, s11p2) %>%
        count() %>%
        ungroup() %>%
        group_by(eth) %>%
        mutate(prop = n/sum(n)*100)

order <- dfacc %>%
        filter(s11p2 == "Have Access") %>%
        arrange(prop) %>%
        rowid_to_column("rank") %>%
        select(eth, rank)

dfacc <- dfacc %>%
        left_join(order, by = "eth")
```

Finally, a graph is created which compares the proportions in rural and urban areas. 

```{r}
p <- ggplot(data = dfacc, aes(y = prop, x = reorder(eth, rank), fill = s11p2)) + theme_bw()
p1 <- p + geom_bar(position = "stack", stat = "identity") 
p2 <- p1 + labs(y = "Proportion of respondents (in %)", x = "", title = "Figure 2: Home Internet Connection of School-Age\nPopulation per Self-identified Ethnicity", subtitle = "Based on data from 10,543 respondents between 5 and 18 years old. Surveyed\nhouseholds were selected through randomised cluster sampling at national level,\nwhere clusters represented different socio-economic strata.", caption = "Source: INEC Multi-Purpose Household Survey 2019", fill = "") + theme(axis.text.x = element_text(angle = 90, vjust = 0.2))
p3 <- p2 + scale_fill_manual(name = "", values = (c("Have Access" = "#A3BFA5", "Do not have Access" = "#A26E6E")))
p3
```

## Digital Literacy

The sub-indicators and their relevant data have been selected and modeled on the (Competence Areas and Competences in the Digital Literacy Global Framework)[http://gaml.cite.hku.hk/] created by UNESCO and partners. Each competence area on which data is available are evaluated as a separate sub-indicator. There is data available on the following competencies: hardware and software operations; information and data literacy; communication and collaboration; digital content creation. There is no data available on the competencies: safety; problem solving; career-related competences. 

```{r echo = FALSE, results = 'asis'}
names <- c("Survey", "Code", "Form Section", "Question", "Responses")
survey <- rep("National Multi-Purpose Household Survey of December 2018", 4)
code <- c("s7p6", "s7p71", "s7p72", "s7p77")
form.section <- c("Section 7, Question 6", "Section 7, question 7, subsection 1", "Section 7, question 7, subsection 2", "Section 7, question 7, subsection 7")
question <- c("Have you used a computer from anywhere in the past 12 months?", "In the past 12 months when using a computer or laptop: have you copied or moved a document or folder?", "In the past 12 months when using a computer or laptop: have you used the copy and paste function in a document?", "In the past 12 months when using a computer or laptop: have you created a digital presentation such as powerpoint, prezi or slideshare?")
responses <- c("1 = yes, 2 = no", rep("1 = yes, 2 = no, 99 = does not know or no answer", 3))
table <- data.frame(cbind(survey, code, form.section, question, responses))
names(table) <- names
kable(table, caption = "Table 2.1: Relevant Variables for Indicator 2.1")
```

```{r}
df1 <- df %>%
  filter(s7p6 == 1 & s1p3 > 14)

df2 <- df1 %>%
  select(id_per, area, "Copied or Moved Document/Folder" = s7p71, "Used Copy/Paste Function"= s7p72, "Sent Emails with Attachment" = s7p73, "Installed New Devices" = s7p75, "Downloaded and installed software" = s7p76,"Created a Digital Presentation" = s7p77, "Used a USB-Stick" = s7p78) %>%
  pivot_longer(-c(id_per, area), names_to = "Action", values_to = "Value") %>%
  mutate(Value = factor(Value, levels = c(1,2,99), labels = c("yes", "no", "no"))) %>%
  mutate(Action = factor(Action)) %>%
  mutate(area = factor(area, levels = 1:2, labels = c("urban", "rural")))

df3 <- df2 %>%
  group_by(area, Action, Value) %>%
  count() %>%
  ungroup() %>%
  group_by(area, Action) %>%
  mutate(prop = n/sum(n)*100) %>%
  filter(Value == "yes") %>%
  ungroup() %>%
  group_by(Action) %>%
  mutate(order = mean(prop))

p <- ggplot(data = df3, aes(x = reorder(Action, order), y = prop, fill = area)) + theme_bw() 
p1 <- p + geom_bar(position = "dodge", stat = "identity") + coord_flip() 
p2 <- p1 + labs(y = "Proportion of respondents who\nperformed the action (in %)", x = "", title = "Figure 3: Digital Actions Performed by\nEcuadorian Computer Users", subtitle = "Based on data from 7,808 respondents who: (1) lived in a household\nwith children and young people of school-going age; (2) had access to\na computer in the past 12 months and (3) were 15 years or older.", caption = "Source: INEC Multi-Purpose Household Survey 2019", fill = "")
p3 <- p2 +  scale_fill_manual(name = "", values = c("urban" = "#907D73", "rural" = "#C1C37F"))
p3
  
```

